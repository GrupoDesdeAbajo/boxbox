/* Copyright 2012 Greg Smith. Licensed under the MIT License. http://incompl.github.com/boxbox/ */
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),function(){function a(a){function b(){}return b.prototype=a,new b}function b(a,b){a===undefined&&(a={});if(b!==undefined)for(var c in b)b.hasOwnProperty(c)&&a[c]===undefined&&(a[c]=b[c]);return a}window.boxbox={};if(Box2D===undefined){console.error("boxbox needs Box2d to work");return}var c=Box2D.Common.Math.b2Vec2,d=Box2D.Common.Math.b2Math,e=Box2D.Dynamics.b2BodyDef,f=Box2D.Dynamics.b2Body,g=Box2D.Dynamics.b2FixtureDef,h=Box2D.Dynamics.b2Fixture,i=Box2D.Dynamics.b2World,j=Box2D.Collision.Shapes.b2MassData,k=Box2D.Collision.Shapes.b2PolygonShape,l=Box2D.Collision.Shapes.b2CircleShape,m=Box2D.Dynamics.b2DebugDraw,n=Box2D.Collision.b2AABB;window.boxbox.createWorld=function(b,c){var d=a(q);return d._init(b,c),d};var o={gravity:10,allowSleep:!0,scale:30},p={type:"distance",allowCollisions:!1},q={_ops:null,_world:null,_canvas:null,_keydownHandlers:{},_keyupHandlers:{},_startContactHandlers:{},_finishContactHandlers:{},_impactHandlers:{},_destroyQueue:[],_impulseQueue:[],_constantVelocities:{},_constantForces:{},_entities:{},_nextEntityId:0,_cameraX:0,_cameraY:0,_onRender:[],_init:function(a,d){var e=this,f,g,h,j;this._ops=b(d,o),this._world=new i(new c(0,this._ops.gravity),!0),h=this._world,this._canvas=a,this._ctx=this._canvas.getContext("2d"),this._scale=this._ops.scale;if(this._canvas!==undefined){if(this._ops.debugDraw){var k=new m;k.SetSprite(this._canvas.getContext("2d")),k.SetDrawScale(this._scale),k.SetFillAlpha(.3),k.SetLineThickness(1),k.SetFlags(m.e_shapeBit|m.e_jointBit),h.SetDebugDraw(k)}(function l(){var a,b,d,f,i,j,k;for(a in e._constantVelocities)d=e._constantVelocities[a],d.body.SetLinearVelocity(new c(d.x,d.y),d.body.GetWorldCenter());for(g=0;g<e._impulseQueue.length;g++)f=e._impulseQueue.pop(),f.body.ApplyImpulse(new c(f.x,f.y),f.body.GetWorldCenter());for(a in e._constantForces)i=e._constantForces[a],i.body.ApplyForce(new c(i.x,i.y),i.body.GetWorldCenter());for(a in e._entities)b=e._entities[a],d=b._body.GetLinearVelocity(),d.x>b._ops.maxVelocityX&&(d.x=b._ops.maxVelocityX),d.x<-b._ops.maxVelocityX&&(d.x=-b._ops.maxVelocityX),d.y>b._ops.maxVelocityY&&(d.y=b._ops.maxVelocityY),d.y<-b._ops.maxVelocityY&&(d.y=-b._ops.maxVelocityY);for(g=0;g<e._destroyQueue.length;g++)j=e._destroyQueue.pop(),k=j._id,h.DestroyBody(j._body),delete e._keydownHandlers[k],delete e._startContactHandlers[k],delete e._finishContactHandlers[k],delete e._impactHandlers[k],delete e._destroyQueue[k],delete e._impulseQueue[k],delete e._constantVelocities[k],delete e._constantForces[k],delete e._entities[k];h.Step(1/60,10,10),e._canvas.width=e._canvas.width;for(a in e._entities)b=e._entities[a],b._draw(e._ctx,b._body.m_xf.position.x,b._body.m_xf.position.y);for(g=0;g<e._onRender.length;g++)e._onRender[g].call(e,e._ctx);h.ClearForces(),h.DrawDebugData(),window.requestAnimFrame(l)})(),window.addEventListener("keydown",function(a){for(var b in e._keydownHandlers)e._keydownHandlers[b].call(e._entities[b],a)},!1),window.addEventListener("keyup",function(a){for(var b in e._keyupHandlers)e._keyupHandlers[b].call(e._entities[b],a)},!1),j=new Box2D.Dynamics.b2ContactListener,j.BeginContact=function(a){var b=e._entities[a.GetFixtureA().GetBody()._bbid],c=e._entities[a.GetFixtureB().GetBody()._bbid];for(var d in e._startContactHandlers)b._id===Number(d)&&e._startContactHandlers[d].call(e._entities[d],c),c._id===Number(d)&&e._startContactHandlers[d].call(e._entities[d],b)},j.EndContact=function(a){var b=e._entities[a.GetFixtureA().GetBody()._bbid],c=e._entities[a.GetFixtureB().GetBody()._bbid];for(var d in e._finishContactHandlers)b._id===Number(d)&&e._finishContactHandlers[d].call(e._entities[d],c),c._id===Number(d)&&e._finishContactHandlers[d].call(e._entities[d],b)},j.PostSolve=function(a,b){var c=e._entities[a.GetFixtureA().GetBody()._bbid],d=e._entities[a.GetFixtureB().GetBody()._bbid];for(var f in e._impactHandlers)c._id===Number(f)&&e._impactHandlers[f].call(e._entities[f],d,b.normalImpulses[0],b.tangentImpulses[0]),d._id===Number(f)&&e._impactHandlers[f].call(e._entities[f],c,b.normalImpulses[0],b.tangentImpulses[0])},h.SetContactListener(j)}},_addKeydownHandler:function(a,b){this._keydownHandlers[a]=b},_addKeyupHandler:function(a,b){this._keyupHandlers[a]=b},_addStartContactHandler:function(a,b){this._startContactHandlers[a]=b},_addFinishContactHandler:function(a,b){this._finishContactHandlers[a]=b},_addImpactHandler:function(a,b){this._impactHandlers[a]=b},_destroy:function(a){this._destroyQueue.push(a)},_applyImpulse:function(a,b,c,d){this._impulseQueue.push({id:a,body:b,x:c,y:d})},_setConstantVelocity:function(a,b,c,d,e){this._constantVelocities[a+b]={id:b,body:c,x:d,y:e}},_clearConstantVelocity:function(a,b){delete this._constantVelocities[a+b]},_setConstantForce:function(a,b,c,d,e){this._constantForces[a+b]={id:b,body:c,x:d,y:e}},_clearConstantForce:function(a,b){delete this._constantForces[a+b]},gravity:function(a){a!==undefined&&this._world.SetGravity(new c(0,a));var b=this._world.GetGravity();return{x:b.x,y:b.y}},createEntity:function(){var c={},d=Array.prototype.slice.call(arguments);d.reverse();for(var e in d)b(c,d[e]);var f=a(s),g=this._nextEntityId++;return f._init(this,c,g),this._entities[g]=f,f},createJoint:function(a,c,d){d=d||{},d=b(d,p);var e=d.type,f;e==="distance"?f=new Box2D.Dynamics.Joints.b2DistanceJointDef:e==="revolute"?f=new Box2D.Dynamics.Joints.b2RevoluteJointDef:e==="gear"?f=new Box2D.Dynamics.Joints.b2GearJointDef:e==="friction"?f=new Box2D.Dynamics.Joints.b2FrictionJointDef:e==="prismatic"?f=new Box2D.Dynamics.Joints.b2PrismaticJointDef:e==="weld"?f=new Box2D.Dynamics.Joints.b2WeldJointDef:e==="pulley"?f=new Box2D.Dynamics.Joints.b2PulleyJointDef:e==="mouse"?f=new Box2D.Dynamics.Joints.b2MouseJointDef:e==="line"&&(f=new Box2D.Dynamics.Joints.b2LineJointDef),d.enableMotor&&(f.enableMotor=!0);var g=a._body.GetWorldCenter();d.jointPositionOnEntity1&&(g.x+=d.jointPositionOnEntity1.x,g.y+=d.jointPositionOnEntity1.y);var h=c._body.GetWorldCenter();d.jointPositionOnEntity2&&(h.x+=d.jointPositionOnEntity2.x,h.y+=d.jointPositionOnEntity2.y),e==="mouse"?(f.bodyA=a._body,f.bodyB=c._body):f.Initialize&&f.Initialize(a._body,c._body,g,h),d.allowCollisions&&(f.collideConnected=!0),this._world.CreateJoint(f)},find:function(a,b,c,d){c===undefined&&(c=a),d===undefined&&(d=b);var e=this,f=[],g=new n;return g.lowerBound.Set(a,b),g.upperBound.Set(c,d),this._world.QueryAABB(function(a){return f.push(e._entities[a.GetBody()._bbid]),!0},g),f},camera:function(a){a=a||{};if(a.x===undefined&&a.y===undefined)return{x:this._cameraX,y:this._cameraY};a.x!==undefined&&(this._cameraX=a.x),a.y!==undefined&&(this._cameraY=a.y)},onRender:function(a){this._onRender.push(a)},unbindOnRender:function(a){var b=[],c;for(c=0;c<this._onRender.length;c++)this._onRender[c]!==a&&b.push(this._onRender[c]);this._onRender=b},scale:function(a){return a!==undefined&&(this._scale=a),this._scale},canvasPositionAt:function(a,b){var c=this.camera(),d=this.scale();return{x:Math.round((a+ -c.x)*d),y:Math.round((b+ -c.y)*d)}}},r={name:"unnamed object",x:10,y:5,type:"dynamic",shape:"square",height:1,width:1,radius:1,points:[{x:0,y:0},{x:2,y:0},{x:0,y:2}],density:2,friction:1,restitution:.2,active:!0,fixedRotation:!1,bullet:!1,maxVelocityX:1e3,maxVelocityY:1e3,image:null,imageOffsetX:0,imageOffsetY:0,imageStretchToFit:null,color:"gray",borderColor:"black",borderWidth:1,draw:function(a,b,c){var e=-this._world._cameraX,f=-this._world._cameraY;a.fillStyle=this._ops.color,a.strokeStyle=this._ops.borderColor,a.lineWidth=this._ops.borderWidth;var g,h=this._world._scale,i=this._ops.imageOffsetX||0,j=this._ops.imageOffsetY||0;if(this._sprite!==undefined){var k,l;this._ops.shape==="circle"&&this._ops.imageStretchToFit?(k=l=this._ops.radius*2,b-=this._ops.radius/2,c-=this._ops.radius/2):this._ops.imageStretchToFit?(k=this._ops.width*2,l=this._ops.height*2):(k=this._sprite.width/30,l=this._sprite.height/30);var m=i+(e+b+k/4)*h,n=j+(f+c+l/4)*h;a.translate(m,n),a.rotate(this._body.GetAngle()),a.drawImage(this._sprite,-(k/2*h),-(l/2*h),k*h,l*h),a.rotate(0-this._body.GetAngle()),a.translate(-m,-n)}else if(this._ops.shape==="polygon"||this._ops.shape==="square"){var o=this._body.GetFixtureList().GetShape(),p=parseInt(o.GetVertexCount(),10),q=o.GetVertices(),r=new Vector(p),s=this._body.m_xf;for(g=0;g<p;++g)r[g]=d.MulX(s,q[g]);a.beginPath(),a.moveTo((e+r[0].x)*h,(f+r[0].y)*h);for(g=1;g<r.length;g++)a.lineTo((e+r[g].x)*h,(f+r[g].y)*h);a.closePath(),a.stroke(),a.fill()}else if(this._ops.shape==="circle"){var t=this.position();a.beginPath(),a.arc((e+t.x)*h,(f+t.y)*h,this._ops.radius*h,0,Math.PI*2,!0),a.closePath(),a.stroke(),a.fill()}}},s={_id:null,_ops:null,_body:null,_world:null,_init:function(a,c,d){this._ops=b(c,r);var h=this._ops;this._body=new e;var i=this._body;this._world=a,this._id=d;var j=new g;j.density=h.density,j.friction=h.friction,j.restitution=h.restitution,i.position.x=h.x,i.position.y=h.y,this._name=h.name,h.type==="static"?i.type=f.b2_staticBody:h.type==="dynamic"&&(i.type=f.b2_dynamicBody),h.shape==="square"?(j.shape=new k,j.shape.SetAsBox(h.width,h.height)):h.shape==="circle"?j.shape=new l(h.radius):h.shape==="polygon"&&(j.shape=new k,j.shape.SetAsArray(h.points,h.points.length)),h.draw&&(this._draw=h.draw),h.image&&(this._sprite=new Image,this._sprite.src=h.image),i.active=h.active,i.fixedRotation=h.fixedRotation,i.bullet=h.bullet,this._body=a._world.CreateBody(i),this._body.CreateFixture(j),this._body._bbid=d,h.onStartContact&&this._world._addStartContactHandler(d,h.onStartContact),h.onFinishContact&&this._world._addFinishContactHandler(d,h.onFinishContact),h.onImpact&&this._world._addImpactHandler(d,h.onImpact)},_toVector:function(a,b,c){var d,e;return b=b||0,c===undefined?(b-=90,d=Math.cos(b*(Math.PI/180))*a,e=Math.sin(b*(Math.PI/180))*a):(d=b*a,e=c*a),{x:d,y:e}},name:function(){return this._name},position:function(a){a!==undefined&&this._body.SetPosition(new c(a.x,a.y));var b=this._body.GetPosition();return{x:b.x,y:b.y}},canvasPosition:function(a){a===undefined;var b=this.position();return this._world.canvasPositionAt(b.x,b.y)},rotation:function(a){return a!==undefined&&this._body.SetAngle(a),this._body.GetAngle()},friction:function(a){return a!==undefined&&this._body.GetFixtureList().SetFriction(a),this._body.GetFixtureList().GetFriction()},destroy:function(){this._destroyed=!0,this._world._destroy(this)},applyImpulse:function(a,b,c){var d=this._toVector(a,b,c);this._world._applyImpulse(this._id,this._body,d.x,d.y)},setForce:function(a,b,c,d){var e=this._toVector(b,c,d);this._world._setConstantForce(a,this._id,this._body,e.x,e.y)},setVelocity:function(a,b,c,d){var e=this._toVector(b,c,d);this._world._setConstantVelocity(a,this._id,this._body,e.x,e.y)},clearForce:function(a){this._world._clearConstantForce(a,this._id)},clearVelocity:function(a){this._world._clearConstantVelocity(a,this._id)},onKeydown:function(a){this._world._addKeydownHandler(this._id,a)},onKeyup:function(a){this._world._addKeyupHandler(this._id,a)},onStartContact:function(a){this._world._addStartContactHandler(this._id,a)},onFinishContact:function(a){this._world._addFinishContactHandler(this._id,a)},onImpact:function(a){this._world._addImpactHandler(this._id,a)}}}();